<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Test Hub Connection</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #2d2d2d;
            color: #ffffff;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background-color: #3d3d3d;
            border: 1px solid #555;
        }
        
        .loading {
            background-color: #4a4a00;
            border-color: #666600;
        }
        
        .error {
            background-color: #4a0000;
            border-color: #660000;
        }
        
        .success {
            background-color: #004a00;
            border-color: #006600;
        }
        
        .hub-list {
            margin: 10px 0;
            padding: 10px;
            background-color: #3d3d3d;
            border-radius: 5px;
        }
        
        .hub-item {
            padding: 5px;
            margin: 2px 0;
            background-color: #4d4d4d;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h2>Test Hub Connection</h2>
    
    <div id="statusMessage" class="status">Initializing...</div>
    
    <div id="hubList" class="hub-list" style="display: none;">
        <h3>Available Hubs:</h3>
        <div id="hubItems"></div>
    </div>
    
    <script>
        console.log('Test HTML loaded');
        
        function setStatus(message, type = 'normal') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status';
            if (type === 'loading') statusEl.classList.add('loading');
            if (type === 'error') statusEl.classList.add('error');
            if (type === 'success') statusEl.classList.add('success');
        }
        
        function onHubsLoaded(hubs) {
            console.log('onHubsLoaded called with:', hubs);
            setStatus('Hub data received!', 'success');
            
            try {
                const hubsData = JSON.parse(hubs);
                console.log('Parsed hubs data:', hubsData);
                
                if (hubsData.length === 0) {
                    setStatus('No hubs found in your account', 'error');
                    return;
                }
                
                // Display hubs
                const hubList = document.getElementById('hubList');
                const hubItems = document.getElementById('hubItems');
                
                hubItems.innerHTML = '';
                hubsData.forEach((hub, index) => {
                    const hubDiv = document.createElement('div');
                    hubDiv.className = 'hub-item';
                    hubDiv.textContent = `${index + 1}. ${hub.name} (ID: ${hub.id})`;
                    hubItems.appendChild(hubDiv);
                });
                
                hubList.style.display = 'block';
                setStatus(`Successfully loaded ${hubsData.length} hubs`, 'success');
                
            } catch (e) {
                console.error('Error parsing hubs data:', e);
                setStatus('Error parsing hub data: ' + e.message, 'error');
            }
        }
        
        function onError(message) {
            console.error('Error from Fusion 360:', message);
            setStatus('Error: ' + message, 'error');
        }
        
        // Required JavaScript handler for Fusion 360 sendInfoToHTML communication
        window.fusionJavaScriptHandler = {
            handle: function(action, data) {
                try {
                    console.log('Received from Fusion 360 - Action:', action, 'Data:', data);
                    
                    if (action === 'onHubsLoaded') {
                        onHubsLoaded(data);
                        return 'OK';
                    } else if (action === 'onError') {
                        onError(data);
                        return 'OK';
                    } else {
                        console.log('Unknown action:', action);
                        return 'Unknown action: ' + action;
                    }
                } catch (e) {
                    console.error('Error in fusionJavaScriptHandler:', e);
                    setStatus('Error handling data from Fusion 360: ' + e.message, 'error');
                    return 'FAILED: ' + e.message;
                }
            }
        };
        
        // Wait for Python to send data via sendInfoToHTML
        setStatus('Waiting for hub data from Python...', 'loading');
        console.log('HTML ready with fusionJavaScriptHandler, waiting for sendInfoToHTML data...');
        
        // Add timeout to detect if no data comes
        setTimeout(function() {
            if (document.getElementById('statusMessage').textContent.includes('Waiting for hub data')) {
                setStatus('Timeout: No data received from Fusion 360', 'error');
                console.error('Timeout: No hub data received after 8 seconds');
            }
        }, 8000);
        
        console.log('Test HTML ready, waiting for data...');
    </script>
</body>
</html>
